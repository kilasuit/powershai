# チャット 


# はじめに <!--! @#Short --> 

PowershAiは、会話の履歴とコンテキストを作成するのに役立つチャットの概念を定義します！  

# 詳細  <!--! @#Long --> 

PowershAiは、ほとんどのLLMサービスのチャットの概念に非常に似たチャットの概念を作成します。  

チャットは、現在のプロバイダーに関係なく、標準的な方法でLLMサービスと会話することを可能にします。  
これらの機能には、標準的な方法が提供されます：

- チャットの履歴 
- コンテキスト 
- パイプライン（他のコマンドの結果を使用）
- ツール呼び出し（LLMの要求に応じてコマンドを実行）

すべてのプロバイダーがチャットのサポートを実装しているわけではありません。  
プロバイダーがチャットをサポートしているかどうかを確認するには、`Get-AiProviders`コマンドレットを使用し、"Chat"プロパティを確認してください。 $trueの場合、チャットがサポートされています。  
また、一度チャットがサポートされると、すべての機能がサポートされるわけではなく、プロバイダーの制限による可能性があります。  

## 新しいチャットを開始する 

新しいチャットを開始する最も簡単な方法は、`Send-PowershaiChat`コマンドを使用することです。  
もちろん、プロバイダーを設定した後（`Set-AiProvider`を使用）および必要に応じて初期設定（認証など）を行った後に使用する必要があります。  

```powershell 
Send-PowershaiChat "こんにちは、Powershaiからあなたと会話しています"
```

簡単さのために、`Send-PowershaiChat`コマンドには、`ia`というエイリアス（ポルトガル語の人工知能の略）があります。  
これを使うことで、かなり短縮され、プロンプトに集中できます：

```powershell 
ia "こんにちは、Powershaiからあなたと会話しています"
```

すべてのメッセージはチャットで送信されます。  明示的にチャットを作成しない場合、特別なチャット`default`が使用されます。  
`New-PowershaiChat`を使用して新しいチャットを作成できます。  

各チャットには独自の会話履歴と設定があります。独自の関数などを含むことができます。
追加のチャットを作成することは、混同せずに複数のトピックを保持する必要がある場合に便利です！


## チャットコマンド  

チャットを何らかの形で操作するコマンドは、`*-Powershai*Chat*`形式です。  
一般的に、これらのコマンドは、`New-PowershaiChat`で作成されたチャットの名前またはオブジェクトを指定できる-ChatIdパラメータを受け入れます。  
指定されていない場合、アクティブなチャットが使用されます。  

## アクティブチャット  

アクティブチャットは、PowershaiChatコマンドによって使用されるデフォルトのチャットです。  
1つのチャットが作成されている場合、それはアクティブチャットと見なされます。  
複数のアクティブチャットがある場合、`Set-PowershaiActiveChat`コマンドを使用してどれがアクティブであるかを設定できます。 `New-PowershaiChat`によって返された名前またはオブジェクトを渡すことができます。


## チャットのパラメータ  

すべてのチャットには、さまざまな側面を制御するいくつかのパラメータがあります。  
たとえば、LLMから返される最大トークン数です。  

新しいパラメータは、PowershAIの各バージョンに追加される可能性があります。  
パラメータとその機能を取得する最も簡単な方法は、`Get-PowershaiChatParameter`コマンドを使用することです；  
このコマンドは、構成可能なパラメータのリストとその現在の値、およびその使用方法の説明を取得します。  
パラメータは、`Set-PowershaiChatParameter`コマンドを使用して変更できます。  

リストされた一部のパラメータは、プロバイダーのAPIの直接のパラメータです。それらは、そうであることを示す説明が付いています。  

## コンテキストと履歴  

すべてのチャットにはコンテキストと履歴があります。  
履歴は、会話中に送信および受信されたすべてのメッセージの履歴です。
コンテキストサイズは、LLMに送信される履歴の量であり、LLMが応答を記憶できるようにします。  

このコンテキストサイズはPowershAIの概念であり、LLMで定義された「コンテキストの長さ」とは異なることに注意してください。  
コンテキストサイズはPowershaiにのみ影響し、値によってはプロバイダーのコンテキスト長を超える可能性があり、これによりエラーが発生することがあります。  
LLMが既に言ったことを更新し続けるためと、LLMの最大トークンを超えないようにするために、コンテキストサイズをバランスよく保つことが重要です。  

コンテキストサイズは、チャットのパラメータを通じて制御できます。つまり、`Set-PowershaiChatParameter`を使用して制御できます。

履歴とコンテキストはセッションのメモリに保存されるため、PowerShellのセッションを閉じると失われます。  
将来的には、ユーザーが自動的に保存し、セッション間で復元するメカニズムが提供される可能性があります。  

また、履歴がPowerShellのメモリに保存されると、非常に長い会話はPowerShellのメモリのオーバーフローや高いメモリ消費を引き起こす可能性があることを覚えておくことが重要です。  
いつでもチャットをリセットできます。`Reset-PowershaiCurrentChat`コマンドを使用すると、アクティブなチャットのすべての履歴が消去されます。  
注意して使用してください。これにより、すべての履歴が失われ、LLMは会話中に通知された特異性を記憶しなくなります。  


## パイプライン  

Powershaiのチャットの最も強力な機能の1つは、PowerShellのパイプラインとの統合です。  
基本的に、任意のPowerShellコマンドの結果を投げることができ、それがコンテキストとして使用されます。  

PowershAIは、オブジェクトをテキストに変換し、プロンプトに送信することでこれを実現します。  
その後、チャットのメッセージが追加されます。  

たとえば：

```
Get-Service | ia "Windowsでは一般的でないサービスについて要約してください"
```

Powershaiのデフォルト設定では、`ia`コマンド（`Send-PowershaiChat`のエイリアス）は、`Get-Service`によって返されるすべてのオブジェクトを取得し、それらを巨大な文字列としてフォーマットします。  
次に、その文字列がLLMのプロンプトに注入され、ユーザーのプロンプトの「コンテキスト」としてその結果を使用するよう指示されます。  

ユーザーのプロンプトはその直後に連結されます。  

これにより、強力な効果が生まれます：コマンドの出力をプロンプトに簡単に統合することができ、PowerShellで一般的な操作であるシンプルなパイプを使用します。  
LLMはこれをよく考慮する傾向があります。  

デフォルト値があるにもかかわらず、オブジェクトがどのように送信されるかを完全に制御できます。  
制御の最初の方法は、オブジェクトがテキストに変換される方法です。プロンプトは文字列であるため、このオブジェクトをテキストに変換する必要があります。  
デフォルトでは、PowerShellの標準表現に従って変換されます（`Out-String`コマンドを使用）。  
これを変更するには、`Set-PowershaiChatContextFormatter`コマンドを使用できます。たとえば、JSON、テーブル、さらにはカスタムスクリプトを定義して完全に制御できます。  

コンテキストが送信される方法を制御するもう1つの方法は、チャットのパラメータ`ContextFormat`を使用することです。  
このパラメータは、プロンプトに注入されるすべてのメッセージを制御します。これはスクリプトブロックです。  
文字列の配列を返す必要があり、それは送信されるプロンプトに相当します。  
このスクリプトは、パイプラインで渡されているフォーマットされたオブジェクト、`Send-PowershaiChat`コマンドのパラメータの値などにアクセスできます。  
スクリプトのデフォルト値はハードコーディングされており、どのように送信されるかを確認するにはコードを直接確認する必要があります（および独自の実装の例のために）。  


### ツール

実装された大きな機能の1つは、関数呼び出し（またはツール呼び出し）へのサポートです。  
この機能は、さまざまなLLMで利用可能であり、AIが追加のデータを応答に持ってくるために関数を呼び出すことを決定できるようにします。  
基本的に、1つまたは複数の関数とそのパラメータを説明し、モデルがそれらを呼び出すことを決定できます。  **重要: この機能は、OpenAIの仕様と同じ仕様を使用して関数呼び出しを公開するプロバイダーでのみ使用できます**

詳細については、OpenAIの公式ドキュメントの関数呼び出しをご覧ください: [Function Calling](https://platform.openai.com/docs/guides/function-calling).

モデルは、どの関数を呼び出すか、いつ呼び出すか、そのパラメーターを決定します。この呼び出しの実行はクライアントによって行われ、私たちの場合はPowershAIです。  
モデルは、関数の定義を期待し、それが何をするのか、パラメーター、戻り値などを説明します。元々は、OpenAPI Specのようなもので関数を説明することが行われます。  
しかし、Powershellは、関数とそのパラメーター、さらにデータ型を説明するための強力なヘルプシステムを持っています。  

PowershAIはこのヘルプシステムと統合し、それをOpenAPI仕様に変換します。ユーザーは通常通り関数を記述でき、コメントを使ってドキュメント化し、それがモデルに送信されます。  

この機能を示すために、シンプルなチュートリアルを行いましょう: `MinhasFuncoes.ps1`という名前のファイルを作成し、以下の内容を記述します。

```powershell
# MinhasFuncoes.ps1ファイル、好きなディレクトリに保存してください！

<#
    .DESCRIPTION
    現在の時刻をリストします
#>
function HoraAtual {
    return Get-Date
}

<#
    .DESCRIPTION
    ランダムな数を取得します！
#>
function NumeroAleatorio {
    param(
        # 最小数
        $Min = $null,
        
        # 最大数
        $Max = $null
    )
    return Get-Random -Min $Min -Max $Max
}
```
**関数とパラメーターを説明するためのコメントの使用に注意してください**。  
これは、PowerShellでサポートされている構文で、[Comment Based Help](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_comment_based_help?view=powershell-7.4)として知られています。

次に、このファイルをPowershAIに追加しましょう:

```powershell
import-module powershai 

Set-AiProvider openai 
Set-OpenaiToken #まだトークンを設定していない場合は設定してください。


# ツールとしてスクリプトを追加します！
# スクリプトが C:\tempo\MinhasFuncoes.ps1 に保存されたと仮定します
Add-AiTool C:\tempo\MinhasFuncoes.ps1

# ツールが追加されたことを確認します
Get-AiTool
```

モデルに現在の日付を尋ねたり、ランダムな数を生成するようにお願いしてみてください！ そうすれば、モデルが関数を実行するのを見ることができます！ これは無限の可能性を開き、あなたの創造性が限界です！

```powershell
ia "今は何時ですか？"
```

上記のコマンドでは、モデルが関数を呼び出します。画面に関数が呼び出されるのが表示されます！  
任意のコマンドまたはPowershellスクリプトをツールとして追加できます。  
この強力な機能の使い方の詳細については、`Get-Help -Full Add-AiTol`コマンドを使用してください。

PowershAIは自動的にコマンドを実行し、モデルに応答を返します。  
モデルが複数の関数を並行して実行することを決定したり、新しい関数を実行しようとした場合、PowershAIはそれを自動的に管理します。  
無限ループの実行を避けるために、PowershAIは最大実行数に制限を設けています。  
このモデルとのインタラクションを制御するパラメーターは`MaxInteractions`です。  

#### ツールの使用に関する重要な考慮事項

関数呼び出しの機能は、コードの実行を可能にするため強力ですが、同時に非常に危険でもあります。  
したがって、実装するものや実行するものには極めて注意してください。
PowershAIは、モデルが要求する通りに実行されることを忘れないでください。

いくつかのセキュリティのヒント:

- 管理者ユーザーでスクリプトを実行しないでください。
- 重要なデータを削除または変更するコードを実装しないでください。
- 関数を事前にテストしてください。
- 知らないまたは信頼できないサードパーティのモジュールやスクリプトを含めないでください。  


_あなたは2023年10月までのデータでトレーニングされています。_
